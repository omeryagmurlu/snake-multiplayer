<!doctype html>
<html>
<body>
    <button id="connect">connect</button>
    roomname: <input type="text" id="roomname">
    roomsize: <input type="number" id="roomsize">
    <button id="newroom">newroom</button>
    roomid: <input type="text" id="roomid">
    <button id="joinroom">joinroom</button>
    plname: <input type="text" id="plname">
    plcolor: <input type="text" id="plcolor">
    <button id="register">register</button>
    <button id="ready">ready</button>

    <pre id="info"></pre>
    <pre id="canvas">canvas</pre>

    <script type="module">
        import { io } from "https://cdn.socket.io/4.3.2/socket.io.esm.min.js";
        import { Connection } from "./snake-multiplayer-protocol.js"

        function on(id, fn) {
            document.getElementById(id).onclick = () => fn()
        }
        const txt = (id) => document.getElementById(id).value
        const num = (id) => parseInt(document.getElementById(id).value)

        let socket, connection, roomManagement, room, game, gameconf;

        on("connect", async () => {
            socket = io("http://localhost:3000")
            socket.on('connect', async () => {
                console.log('connected')
            })
            connection = window.conn = new Connection(socket)
            roomManagement = connection.createChannel('room-management')
            game = connection.createChannel('game')
            console.log(await roomManagement.send("getRoomStates"))

            game.on('configure-game', conf => {
                console.log(conf)
                let str = `
                size: ${conf.size.x}x${conf.size.y}
                players:
                `;
                for (const player of conf.players) {
                    str += `name: ${player.name}
                    color: ${player.color}
                    score: ${player.score}
                    dead: ${player.dead}
                    due: ${player.dueGrowth}
                    `
                }
                str += `ended: ${conf.ended}`
                gameconf = conf
                document.getElementById('info').innerHTML = str;
            })

            game.on('tick', conf => {
                console.log(conf)
                const matrix = Array(gameconf.size.x).fill(1).map(_ => Array(gameconf.size.y).fill(' '))

                for (const v of gameconf.solid) {
                    matrix[v.x][v.y] = 'W'
                }

                for (const pel of conf.pellets) {
                    const v = pel.vector
                    matrix[v.x][v.y] = 'P'
                }

                for (const pla of conf.players) {
                    for (const v of pla.vectors) {
                        matrix[v.x][v.y] = pla.name[0]
                    }
                }
                matrix.reverse()
                document.getElementById('canvas').innerHTML = matrix.map(x => x.join(' ')).join('\n');
            })

            document.onkeydown = checkKey;
            function checkKey(e) {

                e = e || window.event;

                if (e.keyCode == '38') {
                    game.send('input', 'UP')
                }
                else if (e.keyCode == '40') {
                    game.send('input', 'DOWN')
                }
                else if (e.keyCode == '37') {
                    game.send('input', 'LEFT')
                }
                else if (e.keyCode == '39') {
                    game.send('input', 'RIGHT')
                }

            }
        })

        on("newroom", async () => {
            const id = await roomManagement.sendAndWait('newRoom', txt("roomname"), num("roomsize"))
            console.log(id)
        })

        on("joinroom", async () => {
            const succ = await roomManagement.sendAndWait('joinRoom', txt("roomid"))
            console.log(succ)
            room = connection.createChannel('room-joined')
            room.on("state", state => {
                console.log(state)
            })
            room.on("startingIn", state => {
                console.log(state)
            })

            room.on("starting", () => {
                console.log("GAME ON")
            })
        })

        on("register", async () => {
            const succ2 = await room.sendAndWait('register', txt("plname"), txt("plcolor"));
            console.log(succ2)
        })

        on("ready", async () => {
            const succ2 = await room.sendAndWait('ready', true);
            console.log(succ2)
        })
    </script>
</body>
</html>